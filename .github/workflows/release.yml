name: Easyborg Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      live:
        description: "Live mode (main branch only)"
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

env:
  PYTHON_VERSION: "3.14"
  PACKAGE_NAME: "easyborg"
  GIT_CONFIG_COUNT: 4
  GIT_CONFIG_KEY_0: "advice.defaultBranchName"
  GIT_CONFIG_VALUE_0: "false"
  GIT_CONFIG_KEY_1: "user.name"
  GIT_CONFIG_VALUE_1: "github-actions"
  GIT_CONFIG_KEY_2: "user.email"
  GIT_CONFIG_VALUE_2: "actions@github.com"
  GIT_CONFIG_KEY_3: "advice.detachedHead"
  GIT_CONFIG_VALUE_3: "false"

jobs:

  discover:
    name: Discover
    runs-on: ubuntu-latest
    outputs:
      live: ${{ steps.detect-live.outputs.live }}
      sha: ${{ steps.detect-tag.outputs.sha }}
      tag: ${{ steps.detect-tag.outputs.tag }}
      version: ${{ steps.detect-tag.outputs.version }}
      already_on_pypi: ${{ steps.check_pypi.outputs.already }}

    steps:
      - name: Checkout HEAD (for discovery)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect live mode
        id: detect-live
        run: |
          INPUT_LIVE="${{ github.event.inputs.live || false }}"

          if [[ "$GITHUB_REF" =~ ^refs/tags/ ]]; then
            LIVE=true
            REASON="tag"
          elif [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
            if [[ "$INPUT_LIVE" == "true" ]]; then
              LIVE=true
              REASON="requested"
            else
              LIVE=false
              REASON="not requested"
            fi
          else
            LIVE=false
            REASON="not on main branch"
          fi
          
          echo "live=$LIVE" >> $GITHUB_OUTPUT
          echo "::notice::Trigger ref: $GITHUB_REF, live mode: $LIVE ($REASON)"

      - name: Detect target tag & SHA
        id: detect-tag
        run: |
          TAG=$(git describe --tags --abbrev=0) # find latest tag
          SHA=$(git rev-list -n 1 "$TAG")
          VERSION="${TAG#v}"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          echo "::notice::Target tag: $TAG (version $VERSION), target SHA: $SHA"

          echo "Repository:    $GITHUB_REPOSITORY"
          echo "Workflow name: $GITHUB_WORKFLOW"
          echo "Workflow file: $GITHUB_WORKFLOW_REF"

      - name: Check if version already exists on PyPI
        id: check_pypi
        run: |
          VERSION="${{ steps.detect-tag.outputs.version }}"
          PKG="${{ env.PACKAGE_NAME }}"

          echo "Checking PyPI for $PKG==$VERSION"

          JSON=$(curl -s "https://pypi.org/pypi/$PKG/json")
          
          if echo "$JSON" | jq -e --arg V "$VERSION" '.releases[$V] | length > 0' > /dev/null; then
            echo "::notice::Version $VERSION is already on PyPI"
            echo "already=true" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Version $VERSION is not yet on PyPI"
            echo "already=false" >> "$GITHUB_OUTPUT"
          fi

  publish_pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: discover
    if: ${{ needs.discover.outputs.already_on_pypi == 'false' }}

    steps:
      - name: Checkout tag (for build)
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.discover.outputs.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build backend
        run: pip install build

      - name: Build sdist & wheel
        run: python -m build

      - name: Publish to PyPI (live mode)
        if: ${{ needs.discover.outputs.live == 'true' }}
        uses: pypa/gh-action-pypi-publish@release/v1


  macos-bottle:
    name: Create macOS bottle
    runs-on: macos-15
    # wait for these jobs to complete, also only the jobs in here are available for reference with needs.xyz
    needs: [ discover, publish_pypi ]
    # job isn't triggered if publish_pypi skips, so we need this extra condition
    if: ${{ always() && needs.discover.result == 'success' && (needs.publish_pypi.result == 'success' || needs.publish_pypi.result == 'skipped') }}
    outputs:
      file: ${{ steps.build-bottle.outputs.file }}
      platform: ${{ steps.build-bottle.outputs.platform }}

    steps:
      - name: Checkout HEAD (for tooling)
        uses: actions/checkout@v4

      - name: Set up Python for Formula generator
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install generator dependencies
        run: |
          pip install --upgrade pip
          pip install requests packaging urllib3

      - name: Generate Homebrew Formula
        run: |
          mkdir -p tap/Formula
          python tools/homebrew/generate_homebrew_formula.py \
            --package "${{ env.PACKAGE_NAME }}" \
            --version "${{ needs.discover.outputs.version }}" \
            --python-version "${{ env.PYTHON_VERSION }}" \
            --template tools/homebrew/easyborg.rb.template \
            --output tap/Formula/easyborg.rb

          echo "Created local Formula:"
          cat tap/Formula/easyborg.rb

      - name: Create local tap
        working-directory: tap
        run: |
          git init .
          git add Formula/easyborg.rb
          git commit -m "Add formula"

      - name: Build bottle
        id: build-bottle
        run: |
          brew tap local/easyborg ./tap
          brew install --build-bottle easyborg
          brew bottle easyborg
          
          # rename file to conform with brew standard
          SOURCE_FILE="$(ls *.bottle*.tar.gz)"
          PLATFORM=$(echo "$SOURCE_FILE" | sed -E 's/.*\.(.*)\.bottle.*/\1/')
          VERSION="${{ needs.discover.outputs.version }}"
          TARGET_FILE="easyborg-${VERSION}.${PLATFORM}.bottle.tar.gz"
          mv "$SOURCE_FILE" "$TARGET_FILE"

          echo "file=$TARGET_FILE" >> "$GITHUB_OUTPUT"
          echo "platform=$PLATFORM" >> "$GITHUB_OUTPUT"

      - name: Upload macOS bottle
        uses: actions/upload-artifact@v4
        with:
          name: bottle-macos
          path: ${{ steps.build-bottle.outputs.file }}
          if-no-files-found: error


  linux-bottle:
    runs-on: ubuntu-latest
    name: Create Linux bottle
    needs: [ discover, publish_pypi ]
    if: ${{ always() && needs.discover.result == 'success' && (needs.publish_pypi.result == 'success' || needs.publish_pypi.result == 'skipped') }}
    outputs:
      file: ${{ steps.build-bottle.outputs.file }}
      platform: ${{ steps.build-bottle.outputs.platform }}

    steps:
      - name: Checkout HEAD (for tooling)
        uses: actions/checkout@v4

      - name: Install Linuxbrew
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl file git
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - name: Add Linuxbrew to PATH
        run: |
          echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"
          echo "/home/linuxbrew/.linuxbrew/sbin" >> "$GITHUB_PATH"
          echo "HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew" >> "$GITHUB_ENV"
          echo "HOMEBREW_CELLAR=/home/linuxbrew/.linuxbrew/Cellar" >> "$GITHUB_ENV"
          echo "HOMEBREW_REPOSITORY=/home/linuxbrew/.linuxbrew/Homebrew" >> "$GITHUB_ENV"

      - name: Set up Python for Formula generator
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install generator dependencies
        run: |
          pip install --upgrade pip
          pip install requests packaging urllib3

      - name: Generate Homebrew formula
        run: |
          mkdir -p tap/Formula
          python tools/homebrew/generate_homebrew_formula.py \
            --package "${{ env.PACKAGE_NAME }}" \
            --version "${{ needs.discover.outputs.version }}" \
            --python-version "${{ env.PYTHON_VERSION }}" \
            --template tools/homebrew/easyborg.rb.template \
            --output tap/Formula/easyborg.rb

          echo "Created local Formula:"
          cat tap/Formula/easyborg.rb

      - name: Create local tap
        working-directory: tap
        run: |
          git init .
          git add Formula/easyborg.rb
          git commit -m "Add formula"

      - name: Build bottle
        id: build-bottle
        run: |
          brew tap local/easyborg ./tap
          brew install --build-bottle easyborg
          brew bottle easyborg
          
          # rename file to conform with brew standard
          SOURCE_FILE="$(ls *.bottle*.tar.gz)"
          PLATFORM=$(echo "$SOURCE_FILE" | sed -E 's/.*\.(.*)\.bottle.*/\1/')
          VERSION="${{ needs.discover.outputs.version }}"
          TARGET_FILE="easyborg-${VERSION}.${PLATFORM}.bottle.tar.gz"
          mv "$SOURCE_FILE" "$TARGET_FILE"

          echo "file=$TARGET_FILE" >> "$GITHUB_OUTPUT"
          echo "platform=$PLATFORM" >> "$GITHUB_OUTPUT"

      - name: Upload Linux bottle
        uses: actions/upload-artifact@v4
        with:
          name: bottle-linux
          path: ${{ steps.build-bottle.outputs.file }}
          if-no-files-found: error


  update-release:
    runs-on: ubuntu-latest
    name: Update release
    needs: [ discover, macos-bottle, linux-bottle ]
    if: ${{ always() && needs.macos-bottle.result == 'success' && needs.linux-bottle.result == 'success' }}

    steps:
      - name: Checkout HEAD (for tooling)
        uses: actions/checkout@v4
        with:
          path: head

      - name: Checkout tag (for changelog)
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.discover.outputs.sha }}
          path: tag

      - name: Download macOS bottle
        uses: actions/download-artifact@v4
        with:
          name: bottle-macos
          path: bottles

      - name: Download Linux bottle
        uses: actions/download-artifact@v4
        with:
          name: bottle-linux
          path: bottles

      - name: Extract changelog for this version
        id: changelog
        working-directory: tag
        run: |
          python ../head/tools/changelog/extract_changelog.py CHANGELOG.md "${{ needs.discover.outputs.version }}" > ../changelog.txt
          echo "changelog_path=../changelog.txt" >> "$GITHUB_OUTPUT"
          
          echo "Extracted changelog:"
          cat ../changelog.txt

      - name: Upload bottles to GitHub Release (live mode)
        if: ${{ needs.discover.outputs.live == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bottles/*.bottle*.tar.gz
          tag_name: "${{ needs.discover.outputs.tag }}"
          body_path: ${{ steps.changelog.outputs.changelog_path }}


  update-homebrew:
    name: Update Homebrew
    runs-on: ubuntu-latest
    needs: [ discover, macos-bottle, linux-bottle, update-release ]
    if: ${{ always() && needs.update-release.result == 'success' }}

    steps:
      - name: Checkout tooling (HEAD)
        uses: actions/checkout@v4

      - name: Download macOS bottle
        uses: actions/download-artifact@v4
        with:
          name: bottle-macos
          path: bottles

      - name: Download Linux bottle
        uses: actions/download-artifact@v4
        with:
          name: bottle-linux
          path: bottles

      - name: Set up Python for Formula generator
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install generator dependencies
        run: |
          pip install --upgrade pip
          pip install requests packaging urllib3

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: sebastianhaberey/homebrew-easyborg
          path: tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Generate updated formula with bottles
        run: |
          TAG="v${{ needs.discover.outputs.version }}"
          
          if [[ "${{ needs.discover.outputs.live }}" == "true" ]]; then
            BOTTLE_ROOT_URL="https://github.com/${{ github.repository }}/releases/download/$TAG"
          else
            ROOT_DIR=$(realpath "bottles")
            BOTTLE_ROOT_URL="file://$ROOT_DIR"
          fi
          
          echo "Bottle root URL: $BOTTLE_ROOT_URL"

          python tools/homebrew/generate_homebrew_formula.py \
            --package "${{ env.PACKAGE_NAME }}" \
            --version "${{ needs.discover.outputs.version }}" \
            --python-version "${{ env.PYTHON_VERSION }}" \
            --template tools/homebrew/easyborg.rb.template \
            --output tap/Formula/easyborg.rb \
            --bottle-macos-path "bottles/${{ needs.macos-bottle.outputs.file }}" \
            --bottle-linux-path "bottles/${{ needs.linux-bottle.outputs.file }}" \
            --bottle-root-url "$BOTTLE_ROOT_URL"
          
          echo "Created final Formula:"
          cat tap/Formula/easyborg.rb

      - name: Upload Formula for verify step (dry run)
        if: ${{ needs.discover.outputs.live == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: formula
          path: tap/Formula/easyborg.rb

      - name: Commit and push tap update (live mode)
        if: ${{ needs.discover.outputs.live == 'true' }}
        working-directory: tap
        run: |
          git add Formula/easyborg.rb
          git commit -m "Update Formula for easyborg ${{ needs.discover.outputs.version }}" || echo "No changes"
          git push


  verify-dry-run:
    name: Verify (dry run)
    runs-on: ubuntu-latest
    needs: [ discover, update-homebrew ]
    if: ${{ always() && needs.update-homebrew.result == 'success' && needs.discover.outputs.live == 'false' }}

    steps:
      - name: Install Linuxbrew
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl file git
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - name: Add Linuxbrew to PATH
        run: |
          echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"
          echo "/home/linuxbrew/.linuxbrew/sbin" >> "$GITHUB_PATH"
          echo "HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew" >> "$GITHUB_ENV"
          echo "HOMEBREW_CELLAR=/home/linuxbrew/.linuxbrew/Cellar" >> "$GITHUB_ENV"
          echo "HOMEBREW_REPOSITORY=/home/linuxbrew/.linuxbrew/Homebrew" >> "$GITHUB_ENV"

      - name: Download macOS bottle
        uses: actions/download-artifact@v4
        with:
          name: bottle-macos
          path: bottles

      - name: Download Linux bottle
        uses: actions/download-artifact@v4
        with:
          name: bottle-linux
          path: bottles

      - name: Download Formula
        uses: actions/download-artifact@v4
        with:
          name: formula
          path: tap/Formula

      - name: Init tap
        working-directory: tap
        run: |
          git init .
          git add .
          git commit -m "Add formula"

      - name: Install tap
        run: |
          brew tap local/easyborg ./tap
          brew install easyborg

      - name: Verify tap
        run: |
          which easyborg
          easyborg --version
          easyborg doctor

  verify-live:
    name: Verify (live mode)
    runs-on: ubuntu-latest
    needs: [ discover,update-homebrew ]
    if: ${{ always() && needs.update-homebrew.result == 'success' && needs.discover.outputs.live == 'true' }}

    steps:
      - name: Install Linuxbrew
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl file git
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - name: Add Linuxbrew to PATH
        run: |
          echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"
          echo "/home/linuxbrew/.linuxbrew/sbin" >> "$GITHUB_PATH"
          echo "HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew" >> "$GITHUB_ENV"
          echo "HOMEBREW_CELLAR=/home/linuxbrew/.linuxbrew/Cellar" >> "$GITHUB_ENV"
          echo "HOMEBREW_REPOSITORY=/home/linuxbrew/.linuxbrew/Homebrew" >> "$GITHUB_ENV"

      - name: Download tap
        run: |
          brew tap sebastianhaberey/easyborg
          brew install easyborg

      - name: Verify tap
        run: |
          which easyborg
          easyborg --version
          easyborg doctor
